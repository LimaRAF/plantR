---
title: "Using __plantR__ to Manage Animal Taxonomy with the CTFB Backbone"
date: "`r format(Sys.Date(), '%d %B %Y')`"
author: 
  - Carlos Eduardo Pinto^[Departamento de Ciências Biológicas, ESALQ, Universidade de São Paulo]
  - Renato A. Ferreira de Lima^[Departamento de Ciências Biológicas, ESALQ, Universidade de São Paulo, https://github.com/LimaRAF]
output:
    rmarkdown::html_vignette:
        toc: true
        number_sections: true
    md_document:
      variant: gfm
    pdf_document:
      toc: true
      number_sections: yes
      template: null  
      toc_depth: 3
      df_print: null 
vignette: >
  %\VignetteIndexEntry{Using __plantR__ to Manage Animal Taxonomy with the CTFB Backbone}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
geometry: margin=3cm
---

```{r, include = FALSE}
knitr::opts_chunk$set(collapse = TRUE,
                      comment  = "#>",
                      echo = TRUE,
                      class.output  = "shadebox")
```

```{r load, echo = FALSE, eval = TRUE, include=FALSE}
devtools::load_all() # for development
```

# Installing `plantR`

Install the packages from GitHub if needed and load `plantR`.

```{r, eval = FALSE}
if (!requireNamespace("remotes"))
  install.packages("remotes")
library(remotes)

if (!requireNamespace("plantR"))
  install_github("LimaRAF/plantR")

if (!requireNamespace("plantRdata"))
  install_github("LimaRAF/plantRdata")

library(plantR)
```

---

# A practical example

We will start with a small list of **names of animal species** that
includes common issues (misspellings, synonyms, wrong capitalization,
invalid names). We will save it in an objects called `names`:

```{r, eval = TRUE, collapse = FALSE}
names <- c(
  "Apis mellifera Linnaeus, 1758",                # name accepted with author
  "Apis melifera",                                # misspelling
  "Apis cf. mellifera",                           # open nomenclature
  "Ancyloscelis armatus",                         # synonym of Ancyloscelis apiformis (Fabricius, 1793)
  "Centris aenea",                                # name accepted without author
  "Centris rufa",                                 # synonym of Centris aenea Lepeletier, 1841
  "Centris Rhodoprocta Moure & Seabra, 1960",     # wrong capitalization
  "Lutjanus purpureus",                           # synonym of Lutjanus campechanus (Poey, 1860)
  "Parotocinclus amazonensis",                    # invalid in CTFB; no synonym for this name
  "Panthera onca",                                # name accepted without author
  "Solenopsis bicolor (Emery, 1906)",             # name accepted with author
  "Eucopricus columbi MacLeay, 1819",             # synonym of Sulcophanaeus columbi (MacLeay, 1819)
  "Eucopricus sp.1"                               # incomplete identification 
)
```

---

# Preparing names using `fixSpecies()`

`fixSpecies()` formats and cleans names (notation, casing, authorship
split, notation flags). It accepts either a character vector or a data
frame (default `scientificName` column).

```{r, eval = TRUE, collapse = FALSE}
names_fixed <- fixSpecies(names)
names_fixed[,-c(2,4)]
```

## Internal functions

For this specific list, some functions may not change anything (which
is fine). The goal is to illustrate correct usage of the internal
functions on the **same** input vector of names.

```{r, eval = TRUE, collapse = FALSE}
fixIndet(names)       # detects undetermined names (e.g., "sp.", "indet")
fixCase(names)        # fixes casing (e.g., "Centris Rhodoprocta")
fixAuthors(names)     # splits taxon and author names, if present
```

---

# Validating taxon names using `prepSpecies()`

Next, validate names against the CTFB backbone (ctfbNames) from
plantRdata by loading it into the Global Environment and passing it to
db.

```{r, eval = TRUE, collapse = FALSE}
# load the CTFB backbone (ctfbNames) into the Global Environment
utils::data("ctfbNames", package = "plantRdata")

# validate against CTFB
names_valid <- prepSpecies(
  names_fixed,
  tax.names = c("scientificName.new", "scientificNameAuthorship.new"),
  db = ctfbNames
)

names_valid[,-c(2,3,4,9,11)]
```

*Tip 1:* for large name lists, consider altering the argument `split.letters`, `parallel`, and `cores`. The minimal fuzzy similarity is controlled by `sug.dist`.

*Tip 2:* The maximum distance in fuzzy matching (defaults to 10%) is controlled by the argument `sug.dist`.


## Internal functions

`nameMatching()` is the internal function used for exact and fuzzy
matching. Below, we demonstrate it using the same names (reference names
are the “accepted/standardized” targets):

<!-- Du: Acho que aqui podemos deixar uma exemplo menor -->

```{r, eval = TRUE, collapse = FALSE}
input_names <- c(
  "Apis mellifera Linnaeus, 1758",
  "Apis mellifica",
  "Ancyloscelis armatus",
  "Centris aenea",
  "Centris rufa",
  "Centris Rhodoprocta Moure & Seabra, 1960",
  "Lutjanus purpureus",
  "Parotocinclus amazonensis",
  "Panthera onca",
  "Coelonertus baridioides Solari & Solari, 1906",
  "Solenopsis bicolor (Emery, 1906)",
  "Eucopricus columbi MacLeay, 1819"
)

ref_names <- c(
  "Apis mellifera Linnaeus, 1758",
  "Ancyloscelis apiformis (Fabricius, 1793)",
  "Centris aenea",
  "Centris rhodoprocta Moure & Seabra, 1960",
  "Lutjanus campechanus (Poey, 1860)",
  "Panthera onca",
  "Coelonertus baridioides Solari & Solari, 1906",
  "Solenopsis bicolor (Emery, 1906)",
  "Sulcophanaeus columbi (MacLeay, 1819)"
)

nameMatching(input_names, ref_names)
```

---

# Validating family names using `prepFamily()`

__plantR__ contains an internal dictionary of valid family names which
can be used via the function `prepFamily()`. Currently, valid family
names are available only for plants. But a similar procedure will be
included for animals in the near future. So, for now, the fuction does
not change the input family names.

```{r prepFamily, eval = TRUE, collapse = TRUE}
names_valid <- prepFamily(names_valid,
                          fam.name = "suggestedFamily",
                          spp.name = "scientificName.new", 
                          kingdom = "animalia")
```


# Brief code summary

A compact two-step workflow (CTFB-only):

```{r, eval = TRUE, collapse = FALSE}
# 1) Standardize
names_fixed <- fixSpecies(names)

# 2) Validate agaisnt the CTFB backbone
utils::data("ctfbNames", package = "plantRdata")
names_valid <- prepSpecies(
  names_fixed,
  tax.names = c("scientificName.new", "scientificNameAuthorship.new"),
  db = ctfbNames
)

names_valid[, c("scientificName.new","scientificNameFull","tax.notes")]
```

Or, even simpler, using the wrapper `formatTax()`:

```{r summary, eval = TRUE, collapse = TRUE}
names_df <- data.frame(scientificName = names)
names_df_valid <- formatTax(names_df, db = ctfbNames)
```


---

# Citation

If you use __plantR__, please cite it as:

> Lima, R.A.F., Sánchez-Tapia, A., Mortara, S.R., ter Steege, H., Siqueira, M.F. (2021).
> *plantR*: An R package and workflow for managing species records from biological collections.
> Methods in Ecology and Evolution 14(2): 332–339. https://doi.org/10.1101/2021.04.06.437754

And please also cite the taxonomic backbones that you used:

> Boeger, W., & Valim, M. P. (2024). Brazilian Zoology Group 2023 (version 1.1) [Data set]. Zenodo.
> https://doi.org/10.5281/zenodo.10498290

